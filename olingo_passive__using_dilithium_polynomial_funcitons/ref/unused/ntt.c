#include <stdint.h>
#include "params.h"
#include "ntt.h"
#include "reduce.h"

static const int32_t zetas[N] = {
	0, 570309, 1680906, -1498789, -1729416, 3644143, -3867455, 2872499,
	-1818758, 3187963, 4168894, 1008406, -2201485, -377009, -132343, 3160307,
	-1437362, 1924916, -3167688, 559456, -3811580, -735177, -3649105, -2559385,
	-2122799, -1165374, 399172, -1215680, -3900951, -3112442, 3686010, -899610,
	2405967, 567803, -3026034, -1613412, 4072943, -1441157, -2155200, -3197269,
	2316868, 2897236, -3293740, 4036315, -3194297, 514518, -1371794, 4063602,
	1894685, -4141836, -2635015, 547889, -2974402, 775181, -3118584, -1303883,
	2276299, -2249676, -2674550, -4108108, -679420, 3962514, -4024351, 97661,
	-3083182, 1008415, -2374300, -3461951, -163228, -3492319, -286042, 3810634,
	2969419, 1055123, 3590572, -1198298, 1799550, -863498, 2782131, -890475,
	-1551773, 2154948, 610947, -1758465, -1541187, 1077479, 478958, -1481795,
	-2740624, 1905164, -3697908, -2460456, -3166844, -2854469, 918682, -991804,
	400438, -2140471, -2674725, -1520950, -583291, 3444880, -3348027, 2294517,
	864654, 822534, -4146887, 2955041, -2885662, -3632012, 2648241, -371958,
	3102140, 363060, 374821, 3626052, -3856336, -1385086, 2220439, -542195,
	-1533592, 1250208, 4131654, -650671, -1886497, 1925862, -2234754, 4045333,
	-2275640, -107692, 2982646, 3901772, -2490843, 1096352, 1561717, 2566192,
	1379783, -652106, -2382782, 2429073, -107710, -3836319, -2321196, 2677214,
	3088196, -3968391, 2362521, -986007, -2334124, 1116912, 1593576, 526127,
	2802969, 2899426, -2837266, 271923, -2317454, 1402107, -1615672, 1190121,
	1697375, -927560, 603591, -1436260, -3159209, 3440664, -249122, -1548556,
	-916225, 251004, -3714085, -3655978, 3033819, -2701212, -3028096, -3355320,
	2972444, -1704786, 4100655, -1254008, 898769, -1672297, 939842, -1626586,
	-3968201, 816644, 1293197, -562739, -2254929, 188743, 3725676, 1148339,
	4036071, -2162591, 1911603, 3890369, -3001959, 3331865, -1267953, -2710631,
	1315451, 84807, -3958964, -2808610, 2697400, 1986912, 1178355, -1681724,
	3351806, 2932819, -1487099, 54554, 579603, -618282, 3011898, -3572122,
	3540128, -3022861, -4152252, 26422, -2096614, -558813, -3952169, 798934,
	3062321, 912714, 2923759, 3027726, -1842221, -3755533, -611456, 1898269,
	-577270, -3996023, -3029095, -2685228, 2972964, 2356729, 179506, -2512010,
	3807198, -3634057, 3026721, -1493589, -2723924, -1610031, -2130338, -2837369,
	1986072, 3007204, -1157540, 2790462, -2919132, 1076364, -443217, 2810651
};


/*************************************************
 * Name:        ntt
 *
 * Description: Forward NTT, in-place. No modular reduction is performed after
 *              additions or subtractions. Output vector is in bitreversed order.
 *
 * Arguments:   - uint32_t p[N]: input/output coefficient array
 **************************************************/
void ntt(int32_t a[N])
{
  unsigned int len, start, j, k;
  int32_t zeta, t;

  k = 0;
  for (len = 128; len > 0; len >>= 1)
  {
    for (start = 0; start < N; start = j + len)
    {
      zeta = zetas[++k];
      for (j = start; j < start + len; ++j)
      {
        t = montgomery_reduce((int64_t)zeta * a[j + len]);
        a[j + len] = a[j] - t;
        a[j] = a[j] + t;
      }
    }
  }
}

/*************************************************
 * Name:        invntt_tomont
 *
 * Description: Inverse NTT and multiplication by Montgomery factor 2^32.
 *              In-place. No modular reductions after additions or
 *              subtractions; input coefficients need to be smaller than
 *              Q in absolute value. Output coefficient are smaller than Q in
 *              absolute value.
 *
 * Arguments:   - uint32_t p[N]: input/output coefficient array
 **************************************************/
void invntt_tomont(int32_t a[N])
{
  unsigned int start, len, j, k;
  int32_t t, zeta;
  const int32_t f = DIV; // 41978; // mont^2/256

  k = 256;
  for (len = 1; len < N; len <<= 1)
  {
    for (start = 0; start < N; start = j + len)
    {
      zeta = -zetas[--k];
      for (j = start; j < start + len; ++j)
      {
        t = a[j];
        a[j] = t + a[j + len];
        a[j + len] = t - a[j + len];
        a[j + len] = montgomery_reduce((int64_t)zeta * a[j + len]);
      }
    }
  }

  for (j = 0; j < N; ++j)
  {
    a[j] = montgomery_reduce((int64_t)f * a[j]);
  }
}